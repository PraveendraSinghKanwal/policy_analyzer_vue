<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spreadsheet Viewer</title>
    
    <!-- jQuery and required plugins -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-mousewheel@3.1.13/jquery.mousewheel.min.js"></script>
    
    <!-- Simple spreadsheet viewer using Handsontable instead of Luckysheet -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable@12.3.0/dist/handsontable.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@12.3.0/dist/handsontable.full.min.css">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        #spreadsheet-container {
            width: 100%;
            height: calc(100vh - 60px); /* Account for toolbar */
            overflow: hidden; /* Let Handsontable handle scrolling */
            position: relative;
        }
        
        #toolbar {
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        /* Handsontable specific styles */
        .handsontable {
            width: 100% !important;
            height: 100% !important;
        }
        
        .handsontable .wtHolder {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Ensure the table is visible */
        .handsontable .htCore {
            width: 100% !important;
            height: 100% !important;
        }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 16px;
            color: #666;
        }
        .error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 16px;
            color: #d32f2f;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="spreadsheet-container">
        <div class="loading">Loading spreadsheet viewer...</div>
    </div>
    <div id="toolbar" style="display: none; padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd;">
        <button id="save-btn" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
            ðŸ’¾ Save Changes
        </button>
        <span id="save-status" style="color: #666; font-size: 14px;"></span>
    </div>
    <script>
        let isReady = false;
        let pendingData = null;
        let hot = null;
        let currentData = null;

        // Function to create a simple HTML table as fallback
        function createSimpleTable(container, data) {
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="error">No data available</div>';
                return;
            }

            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.height = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.fontSize = '12px';
            table.style.fontFamily = 'Arial, sans-serif';

            // Create header row
            if (data.length > 0) {
                const headerRow = document.createElement('tr');
                headerRow.style.backgroundColor = '#f5f5f5';
                headerRow.style.fontWeight = 'bold';

                // Add empty cell for row headers
                const emptyCell = document.createElement('th');
                emptyCell.style.border = '1px solid #ddd';
                emptyCell.style.padding = '8px';
                emptyCell.style.textAlign = 'center';
                emptyCell.textContent = '';
                headerRow.appendChild(emptyCell);

                // Add column headers
                const maxCols = Math.max(...data.map(row => row ? row.length : 0));
                for (let i = 0; i < maxCols; i++) {
                    const th = document.createElement('th');
                    th.style.border = '1px solid #ddd';
                    th.style.padding = '8px';
                    th.style.textAlign = 'center';
                    th.textContent = String.fromCharCode(65 + i); // A, B, C, etc.
                    headerRow.appendChild(th);
                }
                table.appendChild(headerRow);
            }

            // Create data rows
            data.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                
                // Add row header
                const rowHeader = document.createElement('td');
                rowHeader.style.border = '1px solid #ddd';
                rowHeader.style.padding = '8px';
                rowHeader.style.textAlign = 'center';
                rowHeader.style.backgroundColor = '#f5f5f5';
                rowHeader.style.fontWeight = 'bold';
                rowHeader.textContent = rowIndex + 1;
                tr.appendChild(rowHeader);

                // Add data cells
                if (row && Array.isArray(row)) {
                    row.forEach(cell => {
                        const td = document.createElement('td');
                        td.style.border = '1px solid #ddd';
                        td.style.padding = '8px';
                        td.style.textAlign = 'left';
                        td.textContent = cell !== null && cell !== undefined ? String(cell) : '';
                        tr.appendChild(td);
                    });
                }

                table.appendChild(tr);
            });

            container.appendChild(table);
        }

        // Function to setup save functionality
        function setupSaveFunctionality() {
            const saveBtn = document.getElementById('save-btn');
            const saveStatus = document.getElementById('save-status');
            
            saveBtn.addEventListener('click', function() {
                if (hot) {
                    const data = hot.getData();
                    console.log('Saving data:', data);
                    
                    // Send data back to parent window
                    window.parent.postMessage({
                        type: 'save-spreadsheet-data',
                        data: data
                    }, '*');
                    
                    saveStatus.textContent = 'Saving...';
                    saveBtn.disabled = true;
                }
            });
        }

        // Function to update spreadsheet data
        function updateSpreadsheetData(data) {
            if (hot && data) {
                currentData = data;
                const spreadsheetData = data && data.length > 0 && data[0].data ? data[0].data : data;
                hot.loadData(spreadsheetData);
                console.log('Spreadsheet data updated');
            }
        }

        // Function to initialize spreadsheet viewer
        function initializeSpreadsheet(data) {
            try {
                console.log('Initializing spreadsheet with data:', data);
                
                // Clear loading message
                const container = document.getElementById('spreadsheet-container');
                container.innerHTML = '';
                
                // Convert Luckysheet data format to Handsontable format
                let spreadsheetData = [];
                if (data && data.length > 0 && data[0].data) {
                    spreadsheetData = data[0].data;
                    console.log('Extracted spreadsheet data:', spreadsheetData);
                } else {
                    console.warn('No valid data found in:', data);
                    // Try alternative data formats
                    if (Array.isArray(data)) {
                        spreadsheetData = data;
                    } else if (data && data.data) {
                        spreadsheetData = data.data;
                    }
                }
                
                // Ensure we have some data
                if (!spreadsheetData || spreadsheetData.length === 0) {
                    throw new Error('No data available to display');
                }
                
                console.log('Final spreadsheet data:', spreadsheetData);
                
                // Try to initialize Handsontable
                try {
                    // Ensure container is properly sized
                    container.style.width = '100%';
                    container.style.height = '100%';
                    container.style.minHeight = '400px';
                    container.style.overflow = 'hidden';
                    
                    hot = new Handsontable(container, {
                        data: spreadsheetData,
                        rowHeaders: true,
                        colHeaders: true,
                        height: '100%',
                        width: '100%',
                        licenseKey: 'non-commercial-and-evaluation',
                        readOnly: false,
                        stretchH: 'none',
                        autoWrapRow: false,
                        autoWrapCol: false,
                        contextMenu: true,
                        manualRowResize: true,
                        manualColumnResize: true,
                        manualRowMove: true,
                        manualColumnMove: true,
                        filters: true,
                        dropdownMenu: true,
                        columnSorting: true,
                        comments: true,
                        fillHandle: true,
                        formulas: true,
                        minSpareRows: 5,
                        minSpareCols: 2,
                        outsideClickDeselects: false,
                        preventOverflow: 'horizontal',
                        viewportColumnRenderingOffset: 70,
                        viewportRowRenderingOffset: 70,
                        scrollbarH: true,
                        scrollbarV: true,
                        enterMoves: { row: 1, col: 0 },
                        enterBeginsEditing: true,
                        tabMoves: { row: 0, col: 1 }
                    });
                    
                    // Force a render after initialization
                    setTimeout(() => {
                        if (hot) {
                            hot.render();
                            console.log('Handsontable rendered successfully');
                            console.log('Handsontable instance:', hot);
                            console.log('Container dimensions:', {
                                width: container.offsetWidth,
                                height: container.offsetHeight,
                                scrollWidth: container.scrollWidth,
                                scrollHeight: container.scrollHeight
                            });
                            
                            // Add a small visual indicator
                            container.style.border = '2px solid #4CAF50';
                            
                            // Show toolbar and setup save functionality
                            document.getElementById('toolbar').style.display = 'block';
                            setupSaveFunctionality();
                            
                            // Test scrolling and editing
                            console.log('Testing scrolling and editing capabilities...');
                            console.log('Is readOnly:', hot.getSettings().readOnly);
                            console.log('Has scrollbars:', {
                                horizontal: hot.getSettings().scrollbarH,
                                vertical: hot.getSettings().scrollbarV
                            });
                            
                            // Add a test button to verify editing
                            const testBtn = document.createElement('button');
                            testBtn.textContent = 'Test Edit';
                            testBtn.style.position = 'absolute';
                            testBtn.style.top = '10px';
                            testBtn.style.right = '10px';
                            testBtn.style.zIndex = '1001';
                            testBtn.onclick = function() {
                                if (hot) {
                                    hot.selectCell(0, 0);
                                    hot.setDataAtCell(0, 0, 'TEST EDIT');
                                    console.log('Test edit applied');
                                }
                            };
                            document.body.appendChild(testBtn);
                        }
                    }, 100);
                    
                    // Add a fallback check to ensure something is visible
                    setTimeout(() => {
                        const hasContent = container.querySelector('.handsontable') || container.querySelector('table');
                        console.log('Container content check:', {
                            container: container,
                            hasHandsontable: !!container.querySelector('.handsontable'),
                            hasTable: !!container.querySelector('table'),
                            containerHTML: container.innerHTML.substring(0, 200) + '...'
                        });
                        if (!hasContent) {
                            console.warn('No content visible, showing fallback');
                            createSimpleTable(container, spreadsheetData);
                        }
                    }, 1000);
                } catch (handsontableError) {
                    console.warn('Handsontable failed, falling back to simple table:', handsontableError);
                    // Fallback to simple HTML table
                    createSimpleTable(container, spreadsheetData);
                    
                    // Show toolbar for simple table too
                    document.getElementById('toolbar').style.display = 'block';
                    setupSaveFunctionality();
                }
                
                console.log('Handsontable initialized successfully');
                
            } catch (error) {
                console.error('Error initializing spreadsheet:', error);
                document.getElementById('spreadsheet-container').innerHTML = 
                    '<div class="error">Error loading spreadsheet data: ' + error.message + '</div>';
            }
        }

        // Listen for messages from parent window
        window.addEventListener('message', function(event) {
            console.log('Received message:', event.data);
            if (event.data && event.data.luckysheetData) {
                console.log('Received luckysheet data:', event.data.luckysheetData);
                if (isReady) {
                    if (hot) {
                        // Update existing spreadsheet
                        updateSpreadsheetData(event.data.luckysheetData);
                    } else {
                        // Initialize new spreadsheet
                        initializeSpreadsheet(event.data.luckysheetData);
                    }
                } else {
                    pendingData = event.data.luckysheetData;
                }
            } else if (event.data && event.data.type === 'save-success') {
                const saveStatus = document.getElementById('save-status');
                const saveBtn = document.getElementById('save-btn');
                saveStatus.textContent = event.data.message;
                saveBtn.disabled = false;
                setTimeout(() => {
                    saveStatus.textContent = '';
                }, 3000);
            } else if (event.data && event.data.type === 'save-error') {
                const saveStatus = document.getElementById('save-status');
                const saveBtn = document.getElementById('save-btn');
                saveStatus.textContent = event.data.message;
                saveStatus.style.color = '#d32f2f';
                saveBtn.disabled = false;
                setTimeout(() => {
                    saveStatus.textContent = '';
                    saveStatus.style.color = '#666';
                }, 5000);
            }
        });

        // Wait for all resources to load
        window.addEventListener('load', function() {
            console.log('Window loaded, checking Handsontable availability...');
            console.log('Handsontable available:', typeof Handsontable !== 'undefined');
            
            // Additional delay to ensure everything is fully loaded
            setTimeout(function() {
                isReady = true;
                console.log('Ready to initialize spreadsheet');
                
                // Send ready message to parent
                window.parent.postMessage({ type: 'luckysheet-ready' }, '*');
                
                // If we have pending data, initialize now
                if (pendingData) {
                    initializeSpreadsheet(pendingData);
                    pendingData = null;
                }
            }, 1500);
        });
    </script>
</body>
</html> 